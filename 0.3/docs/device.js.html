<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>keta – Docs – Source: services/device.js</title>
	<meta name="description" content="jsDoc of Frontend Components for Kiwigrid Platform based AngularJS Apps">

	<link href="/keta/css/keta.min.css" rel="stylesheet">
	<link href="/keta/css/style.css" rel="stylesheet">
	<link href="/keta/css/docs.css" rel="stylesheet">
	<link href="/keta/css/prettify-tomorrow.css" rel="stylesheet">

	<!--[if lt IE 9]>
	<script src="/keta/js/html5shiv.min.js"></script>
	<script src="/keta/js/respond.min.js"></script>
	<![endif]-->
</head>
<body>
	<div class="col-xs-12 col-sm-12 col-md-3 sidebar">
		<p id="logo">
			<a href="/keta/"><img src="/keta/img/keta.svg"></a>
		</p>
		<p class="lead text-center">
			Frontend Components for Kiwigrid Platform based AngularJS Apps
		</p>
		<p class="text-center">
			Version 0.3.18
		</p>
		<p class="text-center hidden-xs hidden-sm">
			<a class="btn btn-primary" href="https://github.com/kiwigrid/keta/zipball/0.3.18" role="button">ZIP File</a>
			<a class="btn btn-primary" href="https://github.com/kiwigrid/keta/tarball/0.3.18" role="button">TAR Ball</a>
		</p>
		<p class="text-center visible-xs visible-sm">
			<a class="btn btn-lg btn-primary" href="https://github.com/kiwigrid/keta/zipball/0.3.18" role="button">ZIP File</a>
			<a class="btn btn-lg btn-primary" href="https://github.com/kiwigrid/keta/tarball/0.3.18" role="button">TAR Ball</a>
		</p>
		<ul class="nav nav-pills nav-stacked">
			<li><a href="../index.html">Home</a></li>
			<li><a href="../examples/">Examples</a></li>
			<li class="active"><a href="../docs/">Documentation</a></li>
		</ul>
		<p class="footer text-center hidden-xs hidden-sm">
			View the project on <a href="https://github.com/kiwigrid/keta">Github</a>.<br>
			Maintained by <a href="http://www.kiwigrid.com">Kiwigrid GmbH</a>.<br>
			Licensed under the <a href="https://raw.githubusercontent.com/kiwigrid/keta/master/LICENSE">MIT License</a>.
		</p>
		<p id="company" class="text-center hidden-xs hidden-sm">
			<a href="http://www.kiwigrid.com"><img src="/keta/img/kiwigrid.svg"></a>
		</p>
	</div>

	<div class="col-xs-12 col-sm-12 col-md-2 col-md-offset-3 index">
		<nav>
			<h1><a href="index.html">Index</a></h1><h3>Modules</h3><ul class="list-unstyled"><li><a href="AppBar.html">AppBar</a></li><li><a href="ExtendedTable.html">ExtendedTable</a></li><li><a href="MainMenu.html">MainMenu</a></li><li><a href="Sidebar.html">Sidebar</a></li><li><a href="OrderObjectBy.html">OrderObjectBy</a></li><li><a href="Slice.html">Slice</a></li><li><a href="Unit.html">Unit</a></li><li><a href="shared.html">shared</a></li><li><a href="AccessToken_.html">AccessToken</a></li><li><a href="AppContext_.html">AppContext</a></li><li><a href="Application_.html">Application</a></li><li><a href="ApplicationSet_.html">ApplicationSet</a></li><li><a href="Device_.html">Device</a></li><li><a href="DeviceEvent_.html">DeviceEvent</a></li><li><a href="DeviceSet_.html">DeviceSet</a></li><li><a href="EventBus_.html">EventBus</a></li><li><a href="EventBusDispatcher_.html">EventBusDispatcher</a></li><li><a href="EventBusManager_.html">EventBusManager</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Tag.html">Tag</a></li><li><a href="TagSet.html">TagSet</a></li><li><a href="User.html">User</a></li><li><a href="UserSet.html">UserSet</a></li></ul><h3>Classes</h3><ul class="list-unstyled"><li><a href="AccessToken.html">AccessToken</a></li><li><a href="AppContext.html">AppContext</a></li><li><a href="AppContextProvider.html">AppContextProvider</a></li><li><a href="Application.html">Application</a></li><li><a href="ApplicationInstance.html">ApplicationInstance</a></li><li><a href="ApplicationProvider.html">ApplicationProvider</a></li><li><a href="ApplicationSet.html">ApplicationSet</a></li><li><a href="ApplicationSetInstance.html">ApplicationSetInstance</a></li><li><a href="ApplicationSetProvider.html">ApplicationSetProvider</a></li><li><a href="Device.html">Device</a></li><li><a href="DeviceEvent.html">DeviceEvent</a></li><li><a href="DeviceEventInstance.html">DeviceEventInstance</a></li><li><a href="DeviceEventProvider.html">DeviceEventProvider</a></li><li><a href="DeviceInstance.html">DeviceInstance</a></li><li><a href="DeviceProvider.html">DeviceProvider</a></li><li><a href="DeviceSet.html">DeviceSet</a></li><li><a href="DeviceSetInstance.html">DeviceSetInstance</a></li><li><a href="DeviceSetProvider.html">DeviceSetProvider</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="EventBusDispatcher.html">EventBusDispatcher</a></li><li><a href="EventBusDispatcherProvider.html">EventBusDispatcherProvider</a></li><li><a href="EventBusManager.html">EventBusManager</a></li><li><a href="EventBusManagerProvider.html">EventBusManagerProvider</a></li><li><a href="EventBusProvider.html">EventBusProvider</a></li><li><a href="ketaSharedFactory.html">ketaSharedFactory</a></li><li><a href="LoggerConfig.html">LoggerConfig</a></li><li><a href="LoggerDecorator.html">LoggerDecorator</a></li><li><a href="Tag_.html">Tag</a></li><li><a href="TagInstance.html">TagInstance</a></li><li><a href="TagProvider.html">TagProvider</a></li><li><a href="TagSet_.html">TagSet</a></li><li><a href="TagSetInstance.html">TagSetInstance</a></li><li><a href="TagSetProvider.html">TagSetProvider</a></li><li><a href="User_.html">User</a></li><li><a href="UserInstance.html">UserInstance</a></li><li><a href="UserProvider.html">UserProvider</a></li><li><a href="UserSet_.html">UserSet</a></li><li><a href="UserSetInstance.html">UserSetInstance</a></li><li><a href="UserSetProvider.html">UserSetProvider</a></li></ul>
		</nav>
	</div>

	<div class="col-xs-12 col-sm-12 col-md-7 canvas" id="#top">
		<h1 class="page-title">Source: services/device.js</h1>
		


    
    <section>
        <article>
            <pre class="prettyprint source"><code>'use strict';

/**
 * @name keta.services.Device
 * @author Marco Lehmann &lt;marco.lehmann@kiwigrid.com>
 * @copyright Kiwigrid GmbH 2014-2015
 * @module keta.services.Device
 * @description Device Provider
 */

angular.module('keta.services.Device',
	[
		'keta.services.EventBusDispatcher',
		'keta.services.EventBusManager',
		'keta.services.Logger'
	])

	/**
	 * @class DeviceProvider
	 * @propertyOf keta.services.Device
	 * @description Device Provider
	 */
	.provider('Device', function DeviceProvider() {

		this.$get = function DeviceService($q, $log, EventBusDispatcher, EventBusManager) {

			/**
			 * @class DeviceInstance
			 * @propertyOf Device
			 * @description Device Instance
			 * @param {EventBus} givenEventBus eventBus to use for DeviceInstance
			 * @param {Object} properties Properties to inject into DeviceInstance
			 */
			var DeviceInstance = function(givenEventBus, properties) {

				// keep reference
				var that = this;

				// save EventBus instance
				var eventBus = givenEventBus;

				// populate properties
				angular.forEach(properties, function(value, key) {
					that[key] = value;

					// save copy under $pristine
					if (!angular.isDefined(that.$pristine)) {
						that.$pristine = {};
					}

					that.$pristine[key] = angular.copy(value);
				});

				// send message and return promise
				var sendMessage = function(message) {
					var deferred = $q.defer();

					EventBusDispatcher.send(eventBus, 'deviceservice', message, function(reply) {

						// log if in debug mode
						if (EventBusManager.inDebugMode()) {
							$log.request(['deviceservice', message, reply], $log.ADVANCED_FORMATTER);
						}

						if (reply.code === EventBusDispatcher.RESPONSE_CODE_OK) {
							deferred.resolve(reply);
						} else {
							deferred.reject(reply);
						}

					});

					return deferred.promise;
				};

				var returnRejectedPromise = function(message) {
					var deferred = $q.defer();
					deferred.reject(message);
					return deferred.promise;
				};

				/**
				 * @name $update
				 * @function
				 * @memberOf DeviceInstance
				 * @description
				 * &lt;p>
				 *   Updates a remote DeviceInstance from local one the method is called on.
				 * &lt;/p>
				 * &lt;p>
				 *   Only value changes in &lt;code>tagValues&lt;/code> property will be recognized as changes.
				 * &lt;/p>
				 * @returns {promise} promise
				 * @example
				 * angular.module('exampleApp', ['keta.services.Device'])
				 *     .controller('ExampleController', function(Device) {
				 *         var device = Device.create({
				 *             guid: 'guid',
				 *             tagValues: {
				 *                 IdName: {
				 *                     name: 'IdName',
				 *                     value: 'Device',
				 *                     oca: 0,
				 *                     timestamp: 123456789
				 *                 }
				 *             }
				 *         });
				 *         device.tagValues.IdName.value = 'Modified Device';
				 *         device.$update()
				 *             .then(function(reply) {
				 *                 // success handler
				 *                 // ...
				 *             }, function(reply) {
				 *                 // error handler
				 *                 // ...
				 *             });
				 *     });
				 */
				that.$update = function() {

					// collect changes in tagValues property
					var changes = {
						tagValues: {}
					};

					angular.forEach(that.tagValues, function(tagValue, tagName) {
						if (!angular.isDefined(that.$pristine.tagValues[tagName]) ||
							!angular.equals(that.tagValues[tagName].value, that.$pristine.tagValues[tagName].value)) {
							changes.tagValues[tagName] = {};
							changes.tagValues[tagName].value = tagValue.value;
							changes.tagValues[tagName].oca = tagValue.oca;
						}
					});

					if (Object.keys(changes.tagValues).length) {
						var deferred = $q.defer();

						sendMessage({
							action: 'mergeDevice',
							params: {
								deviceId: that.guid
							},
							body: changes
						}).then(function(reply) {

							// update $pristine copies of succeeded tag values
							if (angular.isDefined(reply.result) &&
								angular.isDefined(reply.result.value) &&
								angular.isDefined(reply.result.value.tagValues)) {
								angular.forEach(reply.result.value.tagValues, function(tag) {
									if (angular.isDefined(that.tagValues[tag.tagName])) {
										that.$pristine.tagValues[tag.tagName] =
											angular.copy(that.tagValues[tag.tagName]);
									}
								});
							}

							deferred.resolve(reply);
						}, function(reply) {
							deferred.reject(reply);
						});

						return deferred.promise;
					}
					return returnRejectedPromise('No changes found');
				};

				/**
				 * @name $delete
				 * @function
				 * @memberOf DeviceInstance
				 * @description
				 * &lt;p>
				 *   Deletes a remote DeviceInstance from local one the method is called on.
				 * &lt;/p>
				 * @returns {promise} promise
				 * @example
				 * angular.module('exampleApp', ['keta.services.Device'])
				 *     .controller('ExampleController', function(Device) {
				 *         var device = Device.create({
				 *             guid: 'guid'
				 *         });
				 *         device.$delete()
				 *             .then(function(reply) {
				 *                 // success handler
				 *                 // ...
				 *             }, function(reply) {
				 *                 // error handler
				 *                 // ...
				 *             });
				 *     });
				 */
				that.$delete = function() {
					return sendMessage({
						action: 'deleteDevice',
						params: {
							deviceId: that.guid
						}
					});
				};

				/**
				 * @name $reset
				 * @function
				 * @memberOf DeviceInstance
				 * @description
				 * &lt;p>
				 *   Resets a DeviceInstance to it's $pristine state.
				 * &lt;/p>
				 * @returns {undefined} nothing
				 * @example
				 * angular.module('exampleApp', ['keta.services.Device'])
				 *     .controller('ExampleController', function(Device) {
				 *         var device = Device.create({
				 *             guid: 'guid',
				 *             tagValues: {
				 *                 IdName: {
				 *                     name: 'IdName',
				 *                     value: 'Device',
				 *                     oca: 0,
				 *                     timestamp: 123456789
				 *                 }
				 *             }
				 *         });
				 *         device.tagValues.IdName.value = 'Modified Device';
				 *         device.$update()
				 *             .then(function(reply) {
				 *                 // success handler
				 *                 // ...
				 *             }, function(reply) {
				 *                 // error handler
				 *                 device.$reset();
				 *             });
				 *     });
				 */
				that.$reset = function() {

					// remove everything beside methods and $pristine copy
					angular.forEach(that, function(value, key) {
						if (!angular.isFunction(value) && key !== '$pristine') {
							delete that[key];
						}
					});

					// add copies of $pristine values
					angular.forEach(that.$pristine, function(value, key) {
						that[key] = angular.copy(value);
					});

				};

			};

			/**
			 * @class Device
			 * @propertyOf DeviceProvider
			 * @description Device Service
			 */
			var api = {

				/**
				 * @function
				 * @memberOf Device
				 * @description
				 * &lt;p>
				 *   Creates a DeviceInstance with given EventBus instance and properties.
				 * &lt;/p>
				 * @param {EventBus} eventBus EventBus instance to use for communication
				 * @param {Object} properties Properties to set upon DeviceInstance creation
				 * @returns {DeviceInstance} DeviceInstance created
				 * @example
				 * angular.module('exampleApp', ['keta.services.Device'])
				 *     .controller('ExampleController', function(Device) {
				 *         var device = Device.create(eventBus, {
				 *             tagValues: {
				 *                 IdName: {
				 *                     name: 'IdName',
				 *                     value: 'Device',
				 *                     oca: 0,
				 *                     timestamp: 123456789
				 *                 }
				 *             }
				 *         });
				 *     });
				 */
				create: function(eventBus, properties) {
					return new DeviceInstance(eventBus, properties);
				}

			};

			return api;

		};

	});
</code></pre>
        </article>
    </section>




	</div>

	<script src="/keta/js/prettify.js"></script>
	<script src="/keta/js/lang-css.js"></script>
	<script> prettyPrint(); </script>
	<script src="/keta/js/linenumber.js"></script>
</body>
</html>
