/**
 * keta 0.4.6
 * Build 2015-08-20T14:56:25.712Z
 *
 * Copyright Kiwigrid GmbH 2014-2015
 * http://kiwigrid.github.io/keta/
 *
 * Licensed under MIT License
 * https://raw.githubusercontent.com/kiwigrid/keta/master/LICENSE
 */
"use strict";angular.module("keta.services.EventBusDispatcher",["keta.services.AccessToken"]).provider("EventBusDispatcher",function(){this.$get=function($window,$timeout,AccessToken){var waitForOpen=function(eventBus,replied,success,error){var timeout=null;if(replied&&(timeout=$timeout(function(){error()},1e3*eventBus.getConfig().requestTimeout)),1!==eventBus.getInstance().readyState()){var onopen=null;angular.isFunction(eventBus.getInstance().onopen)&&(onopen=eventBus.getInstance().onopen),eventBus.getInstance().onopen=function(){angular.isFunction(onopen)&&onopen(),null!==timeout&&$timeout.cancel(timeout),success()}}else $timeout.cancel(timeout),success()},api={STATE_CONNECTING:0,STATE_OPEN:1,STATE_CLOSING:2,STATE_CLOSED:3,RESPONSE_CODE_OK:200,RESPONSE_MESSAGE_OK:"OK",RESPONSE_CODE_BAD_REQUEST:400,RESPONSE_MESSAGE_BAD_REQUEST:"Bad Request",RESPONSE_CODE_UNAUTHORIZED:401,RESPONSE_MESSAGE_UNAUTHORIZED:"Unauthorized",RESPONSE_CODE_NOT_FOUND:404,RESPONSE_MESSAGE_NOT_FOUND:"Not Found",RESPONSE_CODE_REQUEST_TIMEOUT:408,RESPONSE_MESSAGE_REQUEST_TIMEOUT:"Request Time-out",RESPONSE_CODE_AUTHENTICATION_TIMEOUT:419,RESPONSE_MESSAGE_AUTHENTICATION_TIMEOUT:"Authentication Timeout",RESPONSE_CODE_INTERNAL_SERVER_ERROR:500,RESPONSE_MESSAGE_INTERNAL_SERVER_ERROR:"Internal Server Error",RESPONSE_CODE_SERVICE_UNAVAILABLE:503,RESPONSE_MESSAGE_SERVICE_UNAVAILABLE:"Service Unavailable",send:function(eventBus,address,message,replyHandler){message.accessToken=AccessToken.get();var handler=function(reply){reply&&419===reply.code?AccessToken.refresh().then(function(response){angular.isDefined(response.data.accessToken)?(AccessToken.set(response.data.accessToken),api.send(eventBus,address,message,replyHandler)):$window.location.reload()},function(){$window.location.reload()}):angular.isFunction(replyHandler)&&replyHandler(reply)};angular.isDefined(replyHandler)&&angular.isFunction(replyHandler)?waitForOpen(eventBus,!0,function(){eventBus.getInstance().send(address,message,handler)},function(){replyHandler({code:408,message:"Request Time-out"})}):eventBus.getInstance().send(address,message,handler)},publish:function(eventBus,address,message){message.accessToken=AccessToken.get(),waitForOpen(eventBus,!1,function(){eventBus.getInstance().publish(address,message)})},registerHandler:function(eventBus,address,handler){waitForOpen(eventBus,!1,function(){eventBus.getInstance().registerHandler(address,handler)})},unregisterHandler:function(eventBus,address,handler){waitForOpen(eventBus,!1,function(){eventBus.getInstance().unregisterHandler(address,handler)})},close:function(eventBus){eventBus.getInstance().close()},readyState:function(eventBus){return eventBus.getInstance().readyState()},generateUUID:function(){var HEX_RANGE=16,BIT_HALF=8,BIT_SHIFT=3;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a,b){return b=Math.random()*HEX_RANGE,("y"===a?b&BIT_SHIFT|BIT_HALF:0|b).toString(HEX_RANGE)})}};return api}});
//# sourceMappingURL=event-bus-dispatcher.min.js.map